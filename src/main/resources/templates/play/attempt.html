<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title th:text="${quizTitle}">Attempt</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="container py-4">
<a class="btn btn-link px-0" href="/play">← Home</a>

<div th:if="${flashMessage}" class="alert alert-warning" th:text="${flashMessage}"></div>

<h1 class="h3" th:text="${quizTitle}">Quiz</h1>
<p class="text-muted mb-4">
    Player: <span th:text="${attempt.nickname}">Nick</span>
    • Time limit: <span th:text="${timeLimitSeconds}">0</span>s
    • Negatives: <span th:text="${negativePointsEnabled}">false</span>
</p>

<form th:action="@{|/play/attempts/${attempt.id}/submit|}" method="post">
    <div class="card mb-3" th:each="q : ${questions}">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="fw-semibold" th:text="${q.prompt}">Prompt</div>
                    <div class="text-muted small" th:text="${q.type}">TYPE</div>
                </div>
                <div class="text-muted">Points: <span th:text="${q.points}">1</span></div>
            </div>

            <div class="mt-3">

                <!-- SINGLE_CHOICE / LIST_CHOICE -->
                <div th:if="${q.type == 'SINGLE_CHOICE' or q.type == 'LIST_CHOICE'}">
                    <div class="form-label">Choose one</div>

                    <div th:if="${optionsByQuestionId[q.id] == null}" class="text-danger small">
                        No options configured for this question.
                    </div>

                    <div th:each="opt : ${optionsByQuestionId[q.id]}">
                        <div class="form-check">
                            <input class="form-check-input" type="radio"
                                   th:name="${'q_' + q.id}"
                                   th:value="${opt}" required>
                            <label class="form-check-label" th:text="${opt}">Option</label>
                        </div>
                    </div>
                </div>

                <!-- TRUE_FALSE -->
                <div th:if="${q.type == 'TRUE_FALSE'}">
                    <div class="form-label">Select</div>
                    <select class="form-select" th:name="${'q_' + q.id}" required>
                        <option value="" selected disabled>Choose…</option>
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>
                </div>

                <!-- MULTI_CHOICE -->
                <div th:if="${q.type == 'MULTI_CHOICE'}">
                    <div class="form-label">Choose one or more</div>

                    <div th:if="${optionsByQuestionId[q.id] == null}" class="text-danger small">
                        No options configured for this question.
                    </div>

                    <div th:each="opt : ${optionsByQuestionId[q.id]}">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   th:name="${'q_' + q.id}"
                                   th:value="${opt}">
                            <label class="form-check-label" th:text="${opt}">Option</label>
                        </div>
                    </div>

                    <div class="form-text">Pick at least one.</div>
                </div>

                <!-- SHORT_ANSWER -->
                <div th:if="${q.type == 'SHORT_ANSWER'}">
                    <label class="form-label">Answer</label>
                    <input class="form-control" type="text" th:name="${'q_' + q.id}" required>
                </div>

                <!-- FILL_BLANKS (3 blanks fixed for now) -->
                <div th:if="${q.type == 'FILL_BLANKS'}">
                    <div class="form-label">Fill blanks</div>
                    <div class="row g-2">
                        <div class="col-md-4" th:each="i : ${#numbers.sequence(0,2)}">
                            <input class="form-control" type="text"
                                   th:name="${'q_' + q.id + '_' + i}"
                                   th:placeholder="${'Blank ' + (i+1)}"
                                   required>
                        </div>
                    </div>
                    <div class="form-text">This demo uses 3 blanks. We can make it dynamic later.</div>
                </div>

                <!-- SORTING -->
                <div th:if="${q.type == 'SORTING'}">
                    <label class="form-label">Order (comma-separated)</label>
                    <input class="form-control" type="text"
                           th:name="${'q_' + q.id + '_csv'}"
                           placeholder="compile, package, run" required>
                </div>

                <!-- MATCHING -->
                <div th:if="${q.type == 'MATCHING'}">
                    <label class="form-label">Pairs (one per line, LEFT=RIGHT)</label>
                    <textarea class="form-control font-monospace" rows="3"
                              th:name="${'q_' + q.id + '_pairs'}"
                              placeholder="JVM=1&#10;JRE=2" required></textarea>
                </div>

            </div>
        </div>
    </div>

    <button class="btn btn-success" type="submit">Submit</button>
</form>
<script>
    (function () {
        // Push a state so the first Back triggers popstate
        history.pushState({ quizAttempt: true }, "", location.href);

        window.addEventListener("popstate", function (event) {
            // Re-push and keep them on the page
            history.pushState({ quizAttempt: true }, "", location.href);

            alert("Back navigation is disabled during a quiz attempt.");
        });
    })();
</script>
</body>
</html>
